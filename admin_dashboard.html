<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mentorship.AI — Admin</title>
<style>
  :root { --accent:#0af; --text:#fff; --bg:#0b0b0d; --panel:#131317; --border:#2a2a33; }
  body { margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--text); }
  a { color:var(--accent); text-decoration:none; }
  .muted { opacity:.75 }
  .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin:12px 0; }
  input, select, button { font:inherit }
  input, select { background:#0f0f14; color:#fff; border:1px solid var(--border); border-radius:8px; padding:8px; }
  button { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:#1b1b22; color:#fff; cursor:pointer; }
  button:hover { background:#222230; }
  #siteTitle { text-align:center; padding:16px 0; }
  #topNav { text-align:center; margin-bottom:12px; }
  .btn-busy{opacity:.65;pointer-events:none}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);
    border-radius:50%;animation:spin .7s linear infinite;vertical-align:-2px;margin-left:6px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .pill {padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer;}
  .tab.active { background:#1b1b22; }
  .note-box {margin-top:6px; font-size:0.92em}
  .switch { display:inline-flex; align-items:center; gap:8px; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  window.SUPABASE_URL = window.SUPABASE_URL || "https://YOUR-PROJECT.supabase.co";
  window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "YOUR-ANON-KEY";
  window.supabase = window.supabase || supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  window.GOOGLE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCpUVIL4QBXyTVCKN_z-8dQYlmFpSYES3spDxw8RODDYwhypCCLbwemTEoFEZT7ZyKoCeswC3sQgc_/pub?output=csv";
</script>
</head>
<body>
<div id="siteTitle">
  <h1 style="margin:0; font-size:1.6em; color:var(--accent);">
    <a href="index.html" style="color:inherit;">Mentorship.AI — Admin — Empowering Mentorship Connections</a>
  </h1>
</div>
<nav id="topNav">
  <a href="index.html" style="margin:0 10px;">Home</a>
  <a id="navDashboard" href="#" style="margin:0 10px;">Dashboard</a>
  <a id="navSignOut" href="#" style="margin:0 10px;">Sign out</a>
</nav>
<script>
document.addEventListener("DOMContentLoaded", function(){
  const dashLink = document.getElementById("navDashboard");
  const signOutLink = document.getElementById("navSignOut");
  function role(){ return window.__getCurrentUserRole?.(); }
  function updateDash(){
    const r = role();
    if(r==='admin')      dashLink.href='admin_dashboard.html';
    else if(r==='mentor')dashLink.href='mentor_dashboard.html';
    else if(r==='mentee')dashLink.href='mentee_dashboard.html';
    else dashLink.href='#';
  }
  updateDash();
  signOutLink.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{ await window.supabase.auth.signOut(); }catch(_){}
    location.href='index.html';
  });
  if(window.supabase && window.supabase.auth){
    window.supabase.auth.onAuthStateChange(()=>setTimeout(updateDash,300));
  }
});
</script>

<style>:root{--accent:#ffb020}</style>
<div style="text-align:center;margin:8px 0 12px;"><h2>Admin Dashboard</h2></div>
<div class="card">
  <div class="tabs" style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; align-items:center;">
    <div class="tab active pill" data-tab="requests">Requests</div>
    <div class="tab pill" data-tab="mentors">Mentors</div>
    <div class="tab pill" data-tab="mentees">Mentees</div>
    <div style="flex:1"></div>
    <div class="switch">
      <label for="autoSync"><input type="checkbox" id="autoSync" /> Auto‑sync CSV (30s)</label>
    </div>
    <button id="btnSyncCsv" class="pill" title="Sync published Google Sheet → profiles">Sync now</button>
  </div>
  <div class="note-box muted">CSV source: <span id="csvSrc"></span></div>

  <section id="tab-requests">
    <div class="row" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <select id="reqStatus"><option value="">All statuses</option><option>pending</option><option>accepted</option><option>declined</option></select>
      <input id="reqSearch" placeholder="Search by mentor/mentee email" />
      <button class="btn" id="btnLoadReq">Load</button>
      <button class="btn" id="btnExportReq">Export CSV</button>
    </div>
    <table id="reqTable" style="width:100%; border-collapse:collapse; margin-top:8px;">
      <thead><tr><th>Created</th><th>Status</th><th>Mentor</th><th>Mentee</th><th>Note</th><th>Proposed Times</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="tab-mentors" style="display:none;">
    <div class="row" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input id="mentorSearch" placeholder="Search email/name/area" />
      <button class="btn" id="btnLoadMentors">Load</button>
      <button class="btn" id="btnExportMentors">Export CSV</button>
    </div>
    <table id="mentorTable" style="width:100%; border-collapse:collapse; margin-top:8px;">
      <thead><tr><th>Name</th><th>Email</th><th>Expertise</th><th>Region</th><th>Capacity</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="tab-mentees" style="display:none;">
    <div class="row" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input id="menteeSearch" placeholder="Search email/name/interests" />
      <button class="btn" id="btnLoadMentees">Load</button>
      <button class="btn" id="btnExportMentees">Export CSV</button>
    </div>
    <table id="menteeTable" style="width:100%; border-collapse:collapse; margin-top:8px;">
      <thead><tr><th>Name</th><th>Email</th><th>Region</th><th>Interests</th><th>Type</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<script>
(function(){
  const sb = window.supabase;
  const tabs = document.querySelectorAll('.tab');
  document.getElementById('csvSrc').textContent = window.GOOGLE_CSV_URL;

  tabs.forEach(t => t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name = t.dataset.tab;
    document.querySelectorAll('[id^="tab-"]').forEach(s => s.style.display = (s.id === 'tab-'+name ? '' : 'none'));
  }));

  function toCSV(rows, headers){
    const esc = v => '"' + String(v??'').replaceAll('"','""') + '"';
    const head = headers.map(esc).join(',');
    const body = rows.map(r => headers.map(h => esc(r[h])).join(',')).join('\n');
    return head + '\n' + body;
  }
  function download(name, text){
    const blob = new Blob([text], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
  }

  // =============== Requests ===============
  async function loadRequests(){
    const status = document.getElementById('reqStatus').value.trim();
    const qtext  = document.getElementById('reqSearch').value.trim().toLowerCase();
    let q = sb.from('requests').select('*').order('created_at', {ascending:false});
    if(status) q = q.eq('status', status);
    const { data, error } = await q;
    const tbody = document.querySelector('#reqTable tbody'); tbody.innerHTML = '';
    if(error){ tbody.innerHTML = `<tr><td colspan="7">${error.message}</td></tr>`; return; }
    const filtered = data.filter(r =>
      !qtext ||
      (r.mentor_email||'').toLowerCase().includes(qtext) ||
      (r.mentee_email||'').toLowerCase().includes(qtext)
    );
    filtered.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(r.created_at).toLocaleString()}</td>
        <td><span class="muted">${r.status}</span></td>
        <td>${r.mentor_email||''}</td><td>${r.mentee_email||''}</td>
        <td>${r.note||''}</td><td>${r.proposed_times||''}</td>
        <td><button class="btn" data-id="${r.id}" data-s="accepted">Accept</button>
            <button class="btn" data-id="${r.id}" data-s="declined">Decline</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button[data-id]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id=b.dataset.id, s=b.dataset.s;
        b.disabled=true;
        const { error } = await sb.from('requests').update({status:s}).eq('id', id);
        b.disabled=false;
        if(!error) loadRequests(); else alert(error.message);
      });
    });
  }
  document.getElementById('btnLoadReq')?.addEventListener('click', loadRequests);
  document.getElementById('btnExportReq')?.addEventListener('click', async ()=>{
    const { data, error } = await sb.from('requests').select('*').order('created_at',{ascending:false});
    if(error){ alert(error.message); return; }
    const headers = ['id','created_at','status','mentor_email','mentee_email','note','proposed_times'];
    download('requests.csv', toCSV(data, headers));
  });

  // =============== Profiles lists ===============
  async function loadMentors(){
    const qtext = document.getElementById('mentorSearch').value.trim().toLowerCase();
    let { data, error } = await sb.from('profiles').select('*').eq('role','mentor').order('created_at',{ascending:false});
    const tbody = document.querySelector('#mentorTable tbody'); tbody.innerHTML = '';
    if(error){ tbody.innerHTML = `<tr><td colspan="5">${error.message}</td></tr>`; return; }
    const filtered = data.filter(p =>
      !qtext ||
      (p.email||'').toLowerCase().includes(qtext) ||
      (p.name||'').toLowerCase().includes(qtext) ||
      (p.expertise||'').toLowerCase().includes(qtext)
    );
    filtered.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.name||''}</td><td>${p.email||''}</td><td>${p.expertise||''}</td><td>${p.region||''}</td><td>${p.capacity??''}</td>`;
      tbody.appendChild(tr);
    });
  }
  document.getElementById('btnLoadMentors')?.addEventListener('click', loadMentors);
  document.getElementById('btnExportMentors')?.addEventListener('click', async ()=>{
    let { data, error } = await sb.from('profiles').select('*').eq('role','mentor');
    if(error){ alert(error.message); return; }
    const headers = ['user_id','email','name','expertise','region','capacity','created_at'];
    download('mentors.csv', toCSV(data, headers));
  });

  async function loadMentees(){
    const qtext = document.getElementById('menteeSearch').value.trim().toLowerCase();
    let { data, error } = await sb.from('profiles').select('*').eq('role','mentee').order('created_at',{ascending:false});
    const tbody = document.querySelector('#menteeTable tbody'); tbody.innerHTML = '';
    if(error){ tbody.innerHTML = `<tr><td colspan="5">${error.message}</td></tr>`; return; }
    const filtered = data.filter(p =>
      !qtext ||
      (p.email||'').toLowerCase().includes(qtext) ||
      (p.name||'').toLowerCase().includes(qtext) ||
      (p.interests||'').toLowerCase().includes(qtext)
    );
    filtered.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.name||''}</td><td>${p.email||''}</td><td>${p.region||''}</td><td>${p.interests||''}</td><td>${p.type||''}</td>`;
      tbody.appendChild(tr);
    });
  }
  document.getElementById('btnLoadMentees')?.addEventListener('click', loadMentees);
  document.getElementById('btnExportMentees')?.addEventListener('click', async ()=>{
    let { data, error } = await sb.from('profiles').select('*').eq('role','mentee');
    if(error){ alert(error.message); return; }
    const headers = ['user_id','email','name','region','interests','type','created_at'];
    download('mentees.csv', toCSV(data, headers));
  });

  // =============== CSV Auto‑Sync ===============
  function cleanupEmail(v){ return String(v||'').trim().toLowerCase(); }
  function toNull(v){ const s=String(v??'').trim(); return s.length? s : null; }

  let syncInProgress = false;
  async function upsertInChunks(rows, size=150){
    for(let i=0;i<rows.length;i+=size){
      const chunk = rows.slice(i, i+size);
      const { error } = await sb.from('profiles').upsert(chunk, { onConflict: 'email' });
      if(error) throw error;
    }
  }

  async function runCsvSync(){
    if(syncInProgress) return;
    syncInProgress = true;
    const btn = document.getElementById('btnSyncCsv');
    btn.classList.add('btn-busy'); btn.querySelector('.spinner')?.remove();
    btn.insertAdjacentHTML('beforeend','<span class="spinner"></span>');
    try{
      const res = await fetch(window.GOOGLE_CSV_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('Failed to fetch CSV');
      const text = await res.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });

      const mapKey = (row, ...keys) => {
        for(const k of keys){
          const f = Object.keys(row).find(h => h && h.toLowerCase().trim()===k.toLowerCase().trim());
          if(f) return row[f];
        }
        return undefined;
      };

      const records = parsed.data.map(r => ({
        email: cleanupEmail(mapKey(r,'email','Email Address','E-mail','mail')),
        name: toNull(mapKey(r,'name','full name','mentor name')),
        role: toNull(mapKey(r,'role')) || 'mentor',
        expertise: toNull(mapKey(r,'expertise','area of expertise','skills')),
        region: toNull(mapKey(r,'region','country','location')),
        capacity: Number(mapKey(r,'capacity','slots','availability')||0) || null,
        interests: toNull(mapKey(r,'interests')),
        type: toNull(mapKey(r,'type'))
      })).filter(x => x.email);

      if(records.length){
        await upsertInChunks(records);
        // Refresh visible tab if mentors/mentees is open
        const active = document.querySelector('.tab.active')?.dataset.tab;
        if(active==='mentors') await loadMentors();
        if(active==='mentees') await loadMentees();
      }
    }catch(e){
      console.error('CSV auto-sync error:', e);
    }finally{
      btn.classList.remove('btn-busy'); btn.querySelector('.spinner')?.remove();
      syncInProgress = false;
    }
  }

  document.getElementById('btnSyncCsv').addEventListener('click', runCsvSync);

  // Auto‑sync every 30s when enabled and tab visible
  let timer = null;
  function startAuto(){
    if(timer) return;
    timer = setInterval(()=>{
      if(document.hidden) return; // pause when tab not visible
      runCsvSync();
    }, 30000);
  }
  function stopAuto(){
    if(timer){ clearInterval(timer); timer = null; }
  }
  document.getElementById('autoSync').addEventListener('change', (e)=>{
    if(e.target.checked){ startAuto(); runCsvSync(); }
    else stopAuto();
  });
  document.addEventListener('visibilitychange', ()=>{
    // If tab becomes visible and autosync is on, kick once
    if(!document.hidden && document.getElementById('autoSync').checked){
      runCsvSync();
    }
  });

  // Initial loads
  document.addEventListener('DOMContentLoaded', runCsvSync);
  document.addEventListener('DOMContentLoaded', loadRequests);

  // Role guard
  function guard(){
    const r = window.__getCurrentUserRole?.();
    if(!r) return;
    if(r!=='admin'){
      if(r==='mentor') location.replace('mentor_dashboard.html');
      else location.replace('mentee_dashboard.html');
    }
  }
  document.addEventListener('DOMContentLoaded', guard);
  if(window.supabase && window.supabase.auth){
    window.supabase.auth.onAuthStateChange(()=>setTimeout(guard,300));
  }
})();
</script>
</body>
</html>
