<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MentifyHub ‚Äî Mentorship.AI Dashboard</title>
  <style>
    :root{
      --bg:#050712;
      --bg-soft:#080b18;
      --card:#0f1424;
      --card-soft:#11182a;
      --text:#f5f7ff;
      --muted:#9aa3b2;
      --accent:#3bdf96;
      --accent-soft:rgba(59,223,150,0.16);
      --border:#252b3b;
      --border-soft:#1a2030;
      --danger:#ff6b6b;
      --shadow-soft:0 18px 40px rgba(0,0,0,0.55);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(circle at top left, #17233f 0, transparent 55%),
        radial-gradient(circle at bottom right,#102736 0,transparent 50%),
        var(--bg);
    }

    header{
      padding:16px 20px 10px;
      border-bottom:1px solid var(--border-soft);
      position:sticky;
      top:0;
      backdrop-filter:blur(16px);
      background:rgba(5,7,18,0.92);
      z-index:20;
    }

    .header-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .brand-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    .brand-title{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .brand-badge{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:rgba(15,20,36,0.9);
      color:var(--muted);
    }

    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    h1 span.logo-dot{
      width:9px;
      height:9px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#ffffff,#3bdf96);
      box-shadow:0 0 18px rgba(59,223,150,0.9);
      display:inline-block;
    }

    .header-sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    main{
      padding:16px 20px 80px;
      max-width:1200px;
      margin:0 auto;
    }

    .grid{
      display:grid;
      gap:16px;
      grid-template-columns:repeat(12,1fr);
    }

    .card{
      background:linear-gradient(145deg,var(--card),var(--card-soft));
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px 14px 14px;
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-80%;
      background:radial-gradient(circle at top right,rgba(59,223,150,0.06),transparent 60%);
      opacity:0;
      transition:opacity .25s ease;
      pointer-events:none;
    }

    .card:hover::before{
      opacity:1;
    }

    h2{
      margin:0 0 4px;
      font-size:18px;
    }

    .sectionTitle{
      margin:0 0 6px;
      font-size:15px;
      font-weight:600;
    }

    .sectionHeader{display:flex;flex-direction:column;gap:2px;}

    .muted{
      color:var(--muted);
      font-size:12px;
    }

    .grid .card + .card{
      margin-top:0;
    }

    .row{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
    }

    .rowblock{
      margin:8px 0;
    }

    input,
    select,
    button,
    textarea{
      width:100%;
      padding:9px 11px;
      border-radius:12px;
      border:1px solid var(--border-soft);
      background:#070b17;
      color:var(--text);
      font-size:14px;
      font-family:inherit;
      outline:none;
      transition:border-color .18s ease,box-shadow .18s ease,background .18s ease,transform .12s ease;
    }

    input::placeholder,
    textarea::placeholder{
      color:#5e6574;
    }

    select{
      cursor:pointer;
      background-image:linear-gradient(135deg,rgba(255,255,255,0.08),transparent);
    }

    input:focus,
    select:focus,
    textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
      background:#090f1f;
    }

    textarea{
      min-height:70px;
      resize:vertical;
    }

    button{
      background:linear-gradient(145deg,#1c263f,#151b33);
      cursor:pointer;
      border-color:#2b3550;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow:0 10px 22px rgba(0,0,0,0.35);
    }

    button:hover:not(:disabled){
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(0,0,0,0.5);
      background:linear-gradient(145deg,#222f4d,#181f38);
    }

    button:active:not(:disabled){
      transform:translateY(0);
      box-shadow:0 8px 18px rgba(0,0,0,0.35);
    }

    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* Primary action emphasis */
    #btnSaveMentee,
    #btnSaveMentor,
    #btnLoadInbox,
    #btnRefreshMyRequests{
      background:linear-gradient(135deg,#3bdf96,#27b273);
      border-color:#33c786;
      color:#020509;
      box-shadow:0 12px 26px rgba(59,223,150,0.35);
    }

    #btnSaveMentee:hover,
    #btnSaveMentor:hover,
    #btnLoadInbox:hover,
    #btnRefreshMyRequests:hover{
      background:linear-gradient(135deg,#46f3a4,#2abf79);
    }

    .btn-small{
      padding:4px 9px;
      font-size:11px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      width:auto;
      background:rgba(15,22,40,0.95);
      border-color:var(--border);
      box-shadow:none;
    }

    .btn-small:hover{
      background:rgba(20,29,54,0.98);
      box-shadow:0 6px 14px rgba(0,0,0,0.35);
    }

    .btn-danger{
      background:rgba(77,19,28,0.95);
      border-color:#7a2733;
      color:#ffd9de;
    }

    .btn-danger:hover{
      background:#8a2d3b;
    }

    .status{margin-top:8px;}

    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:16px;
    }

    .mcard{
      position:relative;
      overflow:hidden;
      background:radial-gradient(circle at top left,rgba(59,223,150,0.06),transparent 55%),var(--card);
      border-radius:16px;
    }

    .mcard h3{
      margin:8px 0 4px;
      font-size:17px;
    }

    .meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .pill{
      display:inline-block;
      font-size:11px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      margin:2px 4px 0 0;
      background:rgba(11,16,29,0.95);
      color:var(--muted);
      white-space:nowrap;
    }

    .pill.highlight{
      border-color:var(--accent-soft);
      background:var(--accent-soft);
      color:#d5ffe9;
    }

    .avatar{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:12px;
      background:#050813;
    }

    .badge{
      position:absolute;
      top:10px;
      right:10px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--accent-soft);
      background:rgba(5,9,18,0.95);
      font-weight:600;
      font-size:11px;
      color:#c0ffe1;
      backdrop-filter:blur(10px);
    }

    /* Top match styling */
    .badge-top{
      border-color:var(--accent);
      background:linear-gradient(135deg,rgba(59,223,150,0.15),rgba(59,223,150,0.03));
      color:#e9fff5;
      box-shadow:0 0 14px rgba(59,223,150,0.5);
    }

    a{
      color:var(--accent);
      text-decoration:none;
      font-size:12px;
    }

    a:hover{
      text-decoration:underline;
    }

    .error{
      color:var(--danger);
      font-size:12px;
    }

    .tabs{
      display:flex;
      gap:8px;
      margin-top:6px;
      flex-wrap:wrap;
    }

    .tab{
      padding:7px 13px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:rgba(9,13,26,0.9);
      cursor:pointer;
      font-size:13px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      transition:background .18s ease,border-color .18s ease,color .18s ease,transform .12s ease;
    }

    .tab span.emoji{
      font-size:14px;
    }

    .tab.active{
      border-color:var(--accent-soft);
      background:rgba(19,31,49,0.95);
      color:var(--text);
      box-shadow:0 10px 22px rgba(0,0,0,0.45);
      transform:translateY(-1px);
    }

    .hr{
      height:1px;
      background:linear-gradient(to right,transparent,var(--border),transparent);
      margin:10px 0 8px;
    }

    table{
      border-collapse:collapse;
      width:100%;
      font-size:12px;
    }

    th,td{
      padding:6px 8px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }

    thead tr{
      background:#11192b;
    }

    th{
      font-weight:600;
      color:#c5ccdd;
      position:sticky;
      top:0;
      z-index:1;
    }

    .ghost-card{
      border-style:dashed;
      background:transparent;
      box-shadow:none;
    }

    /* Toasts */
    #toastWrap{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .toast{
      background:#121621;
      color:#eaf0ff;
      border:1px solid #262c3a;
      border-left:3px solid #39d98a;
      padding:10px 12px;
      border-radius:10px;
      min-width:220px;
      max-width:360px;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      opacity:0;
      transform:translateY(8px);
      transition:opacity .25s ease,transform .25s ease,border-color .2s ease;
      font-size:14px;
    }

    .toast.show{
      opacity:1;
      transform:translateY(0);
    }

    .toast.error{
      border-left-color:#ff6b6b;
    }

    @media(max-width:860px){
      .row{grid-template-columns:1fr 1fr;}
      main{padding:14px 12px 70px;}
      header{padding-inline:12px;}
    }

    @media(max-width:600px){
      .row{grid-template-columns:1fr;}
      .tab{
        padding:9px 12px;
      }
      .card{
        padding:14px 12px;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand-row">
      <div class="brand-title">
        <h1>
          <span class="logo-dot"></span>
          MentifyHub
        </h1>
        <span class="brand-badge">Mentorship.AI MVP</span>
      </div>
    </div>
    <p class="header-sub">
      Smart matching between mentors and mentees, powered by Supabase.
    </p>
    <div class="tabs">
      <div class="tab active" data-view="mentee">
        <span class="emoji">üôã‚Äç‚ôÄÔ∏è</span><span>Mentee</span>
      </div>
      <div class="tab" data-view="mentor">
        <span class="emoji">üì¨</span><span>Mentor Inbox</span>
      </div>
      <div class="tab" data-view="admin">
        <span class="emoji">üõ†</span><span>Admin</span>
      </div>
    </div>
  </div>
</header>

<main class="grid">
  <!-- Mentee View -->
  <section id="view-mentee" class="card" style="grid-column:span 12;">
    <h2>Find a Mentor</h2>
    <div class="muted" style="margin-bottom:10px;">
      Complete your profile in three quick steps ‚Äî we‚Äôll then recommend mentors based on your region, field, goals, experience level, availability and communication preference.
    </div>

    <!-- About you -->
    <div class="rowblock">
      <div class="sectionHeader">
        <h3 class="sectionTitle">About you</h3>
        <p class="muted" style="margin:2px 0 6px;">
          Tell us who you are and where you‚Äôre based so we can prioritise mentors in similar regions and timezones.
        </p>
      </div>

      <!-- Identity & region -->
      <div class="row">
        <input id="menteeName" placeholder="Your full name" />
        <input id="menteeEmail" placeholder="Your email (used for mentor replies)" />
        <select id="menteeRegion">
          <option value="">Select your region</option>
          <option>Africa</option>
          <option>Europe</option>
          <option>Asia</option>
          <option>North America</option>
          <option>South America</option>
          <option>Oceania</option>
          <option>Middle East</option>
          <option>Other</option>
        </select>
        <input id="menteeRegionOther" placeholder="If Other, specify your region" style="display:none;">
      </div>

      <!-- Country / timezone / field -->
      <div class="row" style="margin-top:8px;">
        <select id="menteeCountry">
          <option value="">Select your country</option>
          <option>United Kingdom</option>
          <option>Nigeria</option>
          <option>South Africa</option>
          <option>Kenya</option>
          <option>Ghana</option>
          <option>Egypt</option>
          <option>United States</option>
          <option>Canada</option>
          <option>France</option>
          <option>Germany</option>
          <option>Netherlands</option>
          <option>Spain</option>
          <option>Italy</option>
          <option>Other</option>
        </select>
        <input id="menteeCountryOther" placeholder="If Other, specify your country" style="display:none;">
        <select id="menteeTimezone">
          <option value="">Select your timezone</option>
          <option>UTC¬±00:00 ‚Äî London, Accra</option>
          <option>UTC+01:00 ‚Äî Lagos, Berlin, Paris</option>
          <option>UTC+02:00 ‚Äî Johannesburg, Cairo</option>
          <option>UTC+03:00 ‚Äî Nairobi, Riyadh</option>
          <option>UTC+04:00 ‚Äî Dubai</option>
          <option>UTC+05:30 ‚Äî New Delhi</option>
          <option>UTC+08:00 ‚Äî Singapore</option>
          <option>Other</option>
        </select>
        <input id="menteeTimezoneOther" placeholder="If Other, specify timezone" style="display:none;">
      </div>

      <div class="row" style="margin-top:8px;">
        <select id="menteeField">
          <option value="">Select your professional field / discipline</option>
          <option>Architecture &amp; Built Environment</option>
          <option>Engineering (Civil, Electrical, Mechanical)</option>
          <option>Sustainability &amp; Green Skills</option>
          <option>Urban Planning &amp; Design</option>
          <option>Technology &amp; AI</option>
          <option>Business &amp; Management</option>
          <option>Education &amp; Research</option>
          <option>Health &amp; Life Sciences</option>
          <option>Law &amp; Policy</option>
          <option>Other</option>
        </select>
        <input id="menteeFieldOther" placeholder="If Other, specify your field" style="display:none;">
        <input id="menteeInterests" placeholder="Your interests (e.g. retrofit, LEED, BIM, solar‚Ä¶)" />
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnSaveMentee">See Matches</button>
          <button id="btnClearMentee" class="btn-small">Start New Profile</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Mentorship goals -->
    <div class="rowblock">
      <div class="sectionHeader">
        <h3 class="sectionTitle">Mentorship goals</h3>
        <p class="muted" style="margin:2px 0 6px;">
          Share what you want from mentorship so we can surface mentors whose focus and strengths match your needs.
        </p>
      </div>

      <!-- Goals / outcomes -->
      <div class="row">
        <input id="menteeGoal" placeholder="Main goal for mentorship (e.g. career clarity, certification, portfolio)" />
        <input id="menteeOutcome" placeholder="What outcome would make this mentorship a success?" />
        <select id="menteeAreas">
          <option value="">Areas you‚Äôd like to be mentored on</option>
          <option>Career Guidance</option>
          <option>Project Feedback</option>
          <option>Technical Skills</option>
          <option>Cerification Preparation</option>
          <option>Research &amp; Academic Support</option>
          <option>Leadership &amp; Networking</option>
          <option>Other</option>
        </select>
        <input id="menteeAreasOther" placeholder="If Other, specify area" style="display:none;">
      </div>
    </div>

    <div class="hr"></div>

    <!-- Availability & communication -->
    <div class="rowblock">
      <div class="sectionHeader">
        <h3 class="sectionTitle">Availability & communication</h3>
        <p class="muted" style="margin:2px 0 6px;">
          Let mentors know when and how you prefer to connect so scheduling is easy from day one.
        </p>
      </div>

      <!-- Level, availability, communication -->
      <div class="row" style="margin-top:4px;">
        <select id="menteeLevel">
          <option value="">Select your experience level</option>
          <option>Student</option>
          <option>Early-career (0‚Äì3 years)</option>
          <option>Mid-career (3‚Äì8 years)</option>
          <option>Experienced professional (8+ years)</option>
        </select>
        <select id="menteeAvailability">
          <option value="">Availability (days / times)</option>
          <option>Morning</option>
          <option>Afternoon</option>
          <option>Evening</option>
          <option>Weekends</option>
          <option>Other</option>
        </select>
        <input id="menteeAvailabilityOther" placeholder="If Other, describe availability" style="display:none;">
        <select id="menteeCommunication">
          <option value="">Preferred mentorship communication</option>
          <option>Email</option>
          <option>Phone</option>
          <option>Virtual (zoom/meet)</option>
          <option>Other</option>
        </select>
      </div>
      <div class="row" style="margin-top:6px;">
        <input id="menteeCommunicationOther" placeholder="If Other, specify communication method" style="display:none;">
        <div></div><div></div><div></div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Search -->
    <div class="row">
      <input id="search" placeholder="(Optional) Search across mentor name, role, skills, bio‚Ä¶" />
      <div></div><div></div><div></div>
    </div>

    <!-- Featured Mentors -->
    <div class="rowblock" style="margin-top:10px;">
      <div class="sectionHeader">
        <h3 class="sectionTitle">Featured mentors</h3>
        <p class="muted" style="margin:4px 0 0;">
          A few mentors to explore while you set up your profile.
        </p>
      </div>
      <div id="featuredMentors" class="cards" style="margin-top:8px;"></div>
    </div>

    <div class="hr"></div>

    <!-- Recommended Mentors -->
    <div class="rowblock">
      <div class="sectionHeader">
        <h3 class="sectionTitle">Recommended for you</h3>
        <p id="suggestionHint" class="muted" style="margin:4px 0 0;">
          Add your interests, region and field ‚Äî we‚Äôll tailor your matches here.
        </p>
      </div>
      <div id="mentors" class="cards" style="margin-top:10px;"></div>
    </div>

    <div class="hr"></div>

    <!-- My Requests -->
    <h3 style="margin-top:10px;">My Requests</h3>
    <div id="myRequests" class="rowblock muted">No requests yet.</div>
    <div class="rowblock">
      <button id="btnRefreshMyRequests">Refresh My Requests</button>
    </div>
  </section>

  <!-- Mentor Inbox -->
  <section id="view-mentor" class="card" style="grid-column:span 12;display:none;">
    <h2>Mentor Inbox</h2>
    <p class="muted" style="margin:2px 0 10px;">
      Enter the email you registered with the admin to see all mentee requests.
    </p>
    <div class="row">
      <input id="inboxEmail" placeholder="Mentor email to load inbox" />
      <button id="btnLoadInbox">Load Inbox</button>
      <button id="btnRefreshInbox">Refresh</button>
      <div></div>
    </div>
    <div id="inbox" class="rowblock muted">Enter a mentor email to view requests.</div>
  </section>

  <!-- Admin View -->
  <section id="view-admin" class="card" style="grid-column:span 12;display:none;">

    <div id="adminLoginCard">
      <h2>Admin login</h2>
      <p class="muted" style="margin:0 0 10px;">
        Only authorised admins can manage mentors. Sign in with your admin email and password.
      </p>
      <div class="row">
        <input id="adminLoginEmail" placeholder="Admin email" />
        <input id="adminLoginPassword" type="password" placeholder="Password" />
        <button id="btnAdminLogin">Sign in</button>
      </div>
      <div id="adminLoginStatus" class="muted" style="margin-top:6px;"></div>
    </div>

    <div id="adminPanel" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Admin Panel ‚Äî Mentors (Supabase)</h2>
        <button id="btnAdminLogout" class="btn-small">Log out</button>
      </div>
      <div class="muted" style="margin:4px 0 8px;">
        This panel manages mentors stored in the <strong>public.mentors</strong> table in Supabase.
        You can add new mentors, edit existing ones, and delete if needed. All matching and mentee suggestions use this database.
      </div>
    <!-- Add / Edit Mentor Form -->
    <div class="rowblock">
      <h3 style="margin-bottom:4px;">Add / Edit Mentor</h3>
      <p class="muted" style="margin:0 0 6px;">Core details</p>
      <div class="row">
        <input id="adminMentorId" type="hidden" />
        <input id="adminName" placeholder="Full name *" />
        <input id="adminEmail" placeholder="Email *" />
        <select id="adminRegion">
          <option value="">Select region</option>
          <option>Africa</option>
          <option>Europe</option>
          <option>Asia</option>
          <option>North America</option>
          <option>South America</option>
          <option>Oceania</option>
          <option>Middle East</option>
          <option>Other</option>
        </select>
        <select id="adminCountry">
          <option value="">Select country</option>
          <option>United Kingdom</option>
          <option>Nigeria</option>
          <option>South Africa</option>
          <option>Kenya</option>
          <option>Ghana</option>
          <option>Egypt</option>
          <option>United States</option>
          <option>Canada</option>
          <option>France</option>
          <option>Germany</option>
          <option>Netherlands</option>
          <option>Spain</option>
          <option>Italy</option>
          <option>Other</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px;">
        <select id="adminTimezone">
          <option value="">Select timezone</option>
          <option>UTC¬±00:00 ‚Äî London, Accra</option>
          <option>UTC+01:00 ‚Äî Lagos, Berlin, Paris</option>
          <option>UTC+02:00 ‚Äî Johannesburg, Cairo</option>
          <option>UTC+03:00 ‚Äî Nairobi, Riyadh</option>
          <option>UTC+04:00 ‚Äî Dubai</option>
          <option>UTC+05:30 ‚Äî New Delhi</option>
          <option>UTC+08:00 ‚Äî Singapore</option>
          <option>Other</option>
        </select>
        <select id="adminField">
          <option value="">Professional field / discipline</option>
          <option>Architecture &amp; Built Environment</option>
          <option>Engineering (Civil, Electrical, Mechanical)</option>
          <option>Sustainability &amp; Green Skills</option>
          <option>Urban Planning &amp; Design</option>
          <option>Technology &amp; AI</option>
          <option>Business &amp; Management</option>
          <option>Education &amp; Research</option>
          <option>Health &amp; Life Sciences</option>
          <option>Law &amp; Policy</option>
          <option>Other</option>
        </select>
        <input id="adminRole" placeholder="Current role / organisation" />
        <input id="adminYearExperience" placeholder="Years exp. (e.g., 5+)" />
      </div>

      <p class="muted" style="margin:10px 0 4px;">Mentorship preferences</p>
      <div class="row" style="margin-top:4px;">
        <textarea id="adminBio" placeholder="Short biography"></textarea>
        <textarea id="adminMainGoal" placeholder="Main goal / focus as a mentor"></textarea>

        <!-- Areas to mentor in (single dropdown like Professional field) -->
        <select id="adminAreasMentor">
          <option value="">Areas to mentor in</option>
          <option value="Career Guidance">Career Guidance</option>
          <option value="Project Feedback">Project Feedback</option>
          <option value="Technical Skills">Technical Skills</option>
          <option value="Cerification Preparation">Cerification Preparation</option>
          <option value="Research & Academic Support">Research &amp; Academic Support</option>
          <option value="Leadership & Networking">Leadership &amp; Networking</option>
          <option value="Other">Other</option>
        </select>

        <!-- Experience levels to mentor (single dropdown like Professional field) -->
        <select id="adminExperienceLevels">
          <option value="">Experience levels to mentor</option>
          <option value="Student">Student</option>
          <option value="Early-career (0‚Äì3 years)">Early-career (0‚Äì3 years)</option>
          <option value="Mid-career (3‚Äì8 years)">Mid-career (3‚Äì8 years)</option>
          <option value="Experienced professional (8+ years)">Experienced professional (8+ years)</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- ‚ÄúOther‚Äù boxes -->
      <div class="row" style="margin-top:6px;">
        <input id="adminAreasMentorOther" placeholder="If Other, specify area(s) to mentor in" />
        <input id="adminExperienceLevelsOther" placeholder="If Other, specify experience level(s)" />
        <div></div><div></div>
      </div>

      <p class="muted" style="margin:10px 0 4px;">Availability &amp; capacity</p>
      <div class="row" style="margin-top:4px;">
        <textarea id="adminExpectedOutcomes" placeholder="Expected outcomes for mentees"></textarea>
        <select id="adminAvailability">
          <option value="">Availability (e.g., Evenings, Weekends)</option>
          <option>Morning</option>
          <option>Afternoon</option>
          <option>Evening</option>
          <option>Weekends</option>
          <option>Other</option>
        </select>
        <select id="adminCommunication">
          <option value="">Preferred communication</option>
          <option>Email</option>
          <option>Phone</option>
          <option>Virtual (zoom/meet)</option>
          <option>Other</option>
        </select>
        <input id="adminLinkedin" placeholder="LinkedIn profile URL" />
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="adminMenteeCapacity" placeholder="How many mentees can this mentor take?" />
        <div></div><div></div><div></div>
      </div>
      <div class="rowblock" style="margin-top:8%;">
        <button id="btnSaveMentor">Save Mentor</button>
        <button id="btnResetMentor" type="button">Clear Form</button>
        <div id="adminFormStatus" class="muted"></div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Mentor Database -->
    <div class="rowblock">
      <h3 style="margin-bottom:4px;">Mentor Database</h3>
      <div id="adminMentorTable" class="muted">Loading mentors‚Ä¶</div>
    </div>
  </section>
    </div>
  </section>
</main>

<div id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<!-- Supabase config -->
<script>
  const SUPABASE_URL = "https://dayxbdhzuiwkmnkehueb.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRheXhiZGh6dWl3a21ua2VodWViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTgyMzAsImV4cCI6MjA3Nzc3NDIzMH0.OU8cUFOUrV0zE0AtJH3BPzhqR70UJu6aNw8eavSf4xc";

  window.SUPABASE_URL = SUPABASE_URL;
  window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

  const REQUIRE_INTERESTS_FIRST = true;
  const SUGGESTION_COUNT = 5;

  // Admin access is now handled via Supabase Auth (email + password).
</script>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.2/dist/umd/supabase.js"></script>
<script>
  const { createClient } = supabase;

  window.supabase = createClient(
    window.SUPABASE_URL,
    window.SUPABASE_ANON_KEY
  );

  window._sbReady = true;
  console.log("‚úÖ Supabase initialised for mentors + requests");

  if (typeof showToast === "function") {
    showToast("Connected to Supabase");
  }
</script>

<script>
  /* ------------ Toasts ------------ */
  function showToast(msg,{type="success",timeout=2800}={}) {
    const w=document.getElementById("toastWrap"); if(!w) return;
    const e=document.createElement("div");
    e.className="toast"+(type==="error"?" error":"");
    e.textContent=msg;
    w.appendChild(e);
    requestAnimationFrame(()=>e.classList.add("show"));
    setTimeout(()=>{
      e.classList.remove("show");
      setTimeout(()=>e.remove(),250);
    },timeout);
  }

  /* ------------ Utilities & state ------------ */
  function debounce(fn,ms=350){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
  const toArray = s => String(s||"").split(/[,;/]/).map(v=>v.trim()).filter(Boolean);
  const norm = s => String(s||"").toLowerCase().replace(/[^a-z0-9\s]/g," ").trim();

  let MENTORS = [];
  let RAW_MENTORS = [];
  let VIEW = [];
  let mentee = {};
  let F = { q: "" };

  // üîê Admin auth via Supabase
  async function checkAdminSession(){
    if(!window.supabase) return;
    try{
      const { data: { session } } = await supabase.auth.getSession();
      const loggedIn = !!session;
      const loginCard = document.getElementById("adminLoginCard");
      const panel = document.getElementById("adminPanel");
      if(loginCard && panel){
        loginCard.style.display = loggedIn ? "none" : "";
        panel.style.display = loggedIn ? "" : "none";
      }
    }catch(e){
      console.error("checkAdminSession error", e);
    }
  }

  const getSelectValue = id => {
    const el=document.getElementById(id);
    return el ? (el.value || "").trim() : "";
  };

  /* ------------ Mapping Supabase row -> internal mentor object ------------ */
  function mapRowToMentor(row){
    return {
      id: row.id,
      name: row.name || "",
      email: row.email || "",
      region: row.region || "",
      country: row.country || "",
      timezone: row.timezone || "",
      field: row.field || "",
      role: row.role || "",
      years: row.year_experience || "",
      bio: row.bio || "",
      mainGoal: row.main_goal || "",
      areasMentor: toArray(row.areas_mentor),
      experienceLevels: toArray(row.experience_levels),
      expectedOutcomes: row.expected_outcomes || "",
      availability: row.availability || "",
      communication: row.communication || "",
      linkedin: row.linkedin || "",
      menteeCapacity: row.mentee_capacity || "",
      skills: toArray(row.areas_mentor),
      topics: toArray(row.expected_outcomes),
      photo: ""
    };
  }

  /* ------------ Matching function ------------ */
  function jaccard(a,b){
    const A=new Set(a.map(norm)),B=new Set(b.map(norm));let inter=0;
    A.forEach(v=>{if(B.has(v)) inter++;});
    const denom=A.size+B.size-inter;
    return denom?inter/denom:0;
  }

  function score(m, me){
    const textTokens=s=>String(s||"").split(/[\s,;/]+/).filter(Boolean);

    let geoScore=0;
    const mr=norm(m.region), mc=norm(m.country), mtz=norm(m.timezone);
    const ur=norm(me.region), uc=norm(me.country), utz=norm(me.timezone);
    if(ur && mr && mr.includes(ur)) geoScore+=0.04;
    if(uc){
      if(mc && mc.includes(uc)) geoScore+=0.03;
      else if(mr && mr.includes(uc)) geoScore+=0.02;
    }
    if(utz && mtz && mtz.includes(utz)) geoScore+=0.03;

    let fieldScore = 0;
    const menteeFieldText = me.field || me.interests;
    if(m.field && menteeFieldText){
      fieldScore = jaccard(textTokens(m.field), textTokens(menteeFieldText));
    }

    let goalScore = 0;
    const menteeGoal = me.goal || me.interests;
    if(m.mainGoal && menteeGoal){
      goalScore = jaccard(textTokens(m.mainGoal), textTokens(menteeGoal));
    }

    let areasScore = 0;
    const mentorAreas = (m.areasMentor && m.areasMentor.length) ? m.areasMentor : (m.skills||[]);
    const menteeAreas = me.areas ? toArray(me.areas) : toArray(me.interests);
    if(mentorAreas.length && menteeAreas.length){
      areasScore = jaccard(mentorAreas, menteeAreas);
    }

    let levelScore = 0;
    if(m.experienceLevels && m.experienceLevels.length && me.level){
      const Lm = m.experienceLevels.map(norm);
      const Lc = norm(me.level);
      if(Lm.includes(Lc)) levelScore=1;
      else if(Lm.some(l=>l.includes(Lc)||Lc.includes(l))) levelScore=0.6;
    }

    let outcomeScore = 0;
    const menteeOutcome = me.outcome || me.interests;
    if(m.expectedOutcomes && menteeOutcome){
      outcomeScore = jaccard(textTokens(m.expectedOutcomes), textTokens(menteeOutcome));
    }

    let availScore = 0;
    if(m.availability && me.availability){
      const ma = norm(m.availability), ua = norm(me.availability);
      if(ma.includes(ua)||ua.includes(ma)) availScore=1;
      else{
        const words=["morning","afternoon","evening","weekend","weekday","saturday","sunday"];
        if(words.some(w=>ma.includes(w)&&ua.includes(w))) availScore=0.6;
      }
    }

    let commScore=0;
    if(m.communication && me.communication){
      const mc2=norm(m.communication), uc2=norm(me.communication);
      if(mc2.includes(uc2)||uc2.includes(mc2)) commScore=1;
      else if(mc2.includes("either")||mc2.includes("both")) commScore=0.8;
    }

    const total =
      geoScore*1.0 +
      fieldScore*0.20 +
      goalScore*0.15 +
      areasScore*0.20 +
      levelScore*0.10 +
      outcomeScore*0.10 +
      availScore*0.10 +
      commScore*0.10;

    return Math.round(total*100);
  }

  function hasProfileReady(me=mentee){
    return (me.interests && me.interests.trim().length>=2) || me.field || me.region;
  }

  /* ------------ Mentor card UI ------------ */
  function buildMentorCard(m,{showScore=true,badgeText}={}){
    const c=document.createElement("div");
    c.className="card mcard";
    let badgeHtml="";

    if(badgeText){
      badgeHtml = `<div class="badge">${badgeText}</div>`;
    } else if(showScore && typeof m._score === "number"){
      if(m._isTop){
        badgeHtml = `<div class="badge badge-top">Top match ‚Ä¢ ${m._score}%</div>`;
      }else{
        badgeHtml = `<div class="badge">${m._score}% match</div>`;
      }
    }

    c.innerHTML=`
      ${badgeHtml}
      ${m.photo?`<img class="avatar" src="${m.photo}" alt="${m.name}">`:""}
      <h3>${m.name||"Unnamed mentor"}</h3>
      <div class="meta">
        ${[m.field,m.role,m.years].filter(Boolean).join(" ‚Ä¢ ")}
      </div>
      ${(m.region||m.country||m.timezone)?`<div class="muted">${[m.region,m.country,m.timezone].filter(Boolean).join(" ‚Ä¢ ")}</div>`:""}
      ${m.bio?`<div class="rowblock">${m.bio}</div>`:""}
      <div>${(m.skills||[]).map(x=>`<span class="pill">${x}</span>`).join("")}</div>
      <div class="rowblock muted">
        ${m.mainGoal?`<div><strong>Main goal as mentor:</strong> ${m.mainGoal}</div>`:""}
        ${m.experienceLevels && m.experienceLevels.length?`<div><strong>Experience levels:</strong> ${m.experienceLevels.join(", ")}</div>`:""}
        ${m.expectedOutcomes?`<div><strong>Expected outcomes:</strong> ${m.expectedOutcomes}</div>`:""}
        ${m.availability?`<div><strong>Availability:</strong> ${m.availability}</div>`:""}
        ${m.communication?`<div><strong>Preferred communication:</strong> ${m.communication}</div>`:""}
        ${m.menteeCapacity?`<div><strong>Can mentor:</strong> ${m.menteeCapacity}</div>`:""}
      </div>
      <div class="rowblock">
        ${m.email?`<button class="btn-small" data-email="${m.email}">Request Mentorship</button>`:""}
        ${m.linkedin?`<a class="pill" target="_blank" rel="noopener" href="${m.linkedin}">LinkedIn</a>`:""}
      </div>`;
    return c;
  }

  function wireRequestButtons(scope){
    const root=scope || document;
    root.querySelectorAll("button[data-email]").forEach(b=>{
      b.onclick=()=>sendRequest(b.dataset.email);
    });
  }

  /* ------------ Featured mentors ------------ */
  function getFeaturedMentors(){
    if(!MENTORS.length) return [];
    const enriched = MENTORS.map((m,idx)=>({
      ...m,
      _yearsNum: parseFloat((String(m.years||"").match(/[\d.]+/)||["0"])[0]) || 0,
      _idx: idx
    }));
    enriched.sort((a,b)=> b._yearsNum - a._yearsNum || a._idx - b._idx);
    return enriched.slice(0,4);
  }

  function renderFeatured(){
    const box=document.getElementById("featuredMentors");
    if(!box) return;
    box.innerHTML="";
    if(!MENTORS.length){
      box.innerHTML="<div class='muted'>No mentors in the database yet. Add mentors from the Admin panel.</div>";
      return;
    }
    const list=getFeaturedMentors();
    list.forEach(m=>{
      const card=buildMentorCard(m,{showScore:false,badgeText:"Featured"});
      box.appendChild(card);
    });
    wireRequestButtons(box);
  }

  /* ------------ Mentee suggestions ------------ */
  function render(){
    const host=document.getElementById("mentors");
    const hint=document.getElementById("suggestionHint");
    if(!host) return;
    host.innerHTML="";
    if(!MENTORS.length){
      if(hint) hint.textContent="No mentors loaded yet. Add mentors from the Admin panel.";
      return;
    }
    if(REQUIRE_INTERESTS_FIRST && !hasProfileReady()){
      if(hint) hint.textContent="Add your interests, region and field ‚Äî suggestions will appear automatically.";
      const ghost=document.createElement("div");
      ghost.className="card ghost-card";
      ghost.innerHTML="Add your interests / region / field ‚Äî suggestions will appear automatically.";
      host.appendChild(ghost);
      return;
    }
    if(!VIEW.length){
      if(hint) hint.textContent="No strong matches yet. Try adjusting your profile or search keywords.";
      host.innerHTML="<div class='muted'>No mentors match yet. Try adjusting your details or keywords.</div>";
      return;
    }
    if(hint) hint.textContent=`Top ${VIEW.length} recommended mentors based on your profile.`;

    VIEW.forEach(m=>{
      const c=buildMentorCard(m,{showScore:true});
      host.appendChild(c);
    });
    wireRequestButtons(host);
  }

  function apply(){
    if(REQUIRE_INTERESTS_FIRST && !hasProfileReady()){
      render();
      return;
    }
    const q=(F.q||"").toLowerCase();
    let ranked=MENTORS
      .map(m=>({...m,_score:score(m,mentee)}))
      .filter(m=>!q || JSON.stringify(m).toLowerCase().includes(q))
      .sort((a,b)=>b._score-a._score);

    // Mark top matches for ribbon
    if(ranked.length){
      const best = ranked[0]._score || 0;
      const cutoff = Math.max(75, best - 5); // top band & above 75%
      ranked = ranked.map(m=>({
        ...m,
        _isTop: m._score >= cutoff && m._score >= 75
      }));
    }

    VIEW = ranked.slice(0,SUGGESTION_COUNT);
    render();
  }

  /* ------------ Supabase: load mentors ------------ */
  async function loadMentors(){
    const box=document.getElementById("adminMentorTable");
    if(box) box.innerHTML="Loading mentors‚Ä¶";
    try{
      const { data, error } = await supabase
        .from("mentors")
        .select("*")
        .order("created_at",{ascending:false});
      if(error) throw error;
      RAW_MENTORS = data || [];
      MENTORS = RAW_MENTORS.map(mapRowToMentor);
      renderFeatured();
      apply();
      renderAdminTable();
      if(!RAW_MENTORS.length && box){
        box.innerHTML="<div class='muted'>No mentors yet. Use the form above to add the first mentor.</div>";
      }
      showToast(`Loaded ${RAW_MENTORS.length} mentor${RAW_MENTORS.length===1?"":"s"}.`);
    }catch(e){
      console.error(e);
      if(box) box.innerHTML="<div class='error'>Failed to load mentors: "+(e.message||e)+"</div>";
      showToast("Failed to load mentors: "+(e.message||"Unknown error"),{type:"error"});
    }
  }

  /* ------------ Admin mentor table + edit/delete ------------ */
  function renderAdminTable(){
    const box=document.getElementById("adminMentorTable");
    if(!box) return;
    if(!RAW_MENTORS.length){
      box.innerHTML="<div class='muted'>No mentors in the database. Use the form above to add one.</div>";
      return;
    }
    const rows = RAW_MENTORS.map(r=>{
      return `
        <tr data-id="${r.id}">
          <td>${r.name||""}</td>
          <td>${r.email||""}</td>
          <td>${r.field||""}</td>
          <td>${r.region||""}</td>
          <td>${r.availability||""}</td>
          <td>${r.timezone||""}</td>
          <td>
            <button class="btn-small" data-action="edit">Edit</button>
            <button class="btn-small btn-danger" data-action="delete">Delete</button>
          </td>
        </tr>
      `;
    }).join("");
    box.innerHTML = `
      <div class="muted" style="margin-bottom:6px;">Total mentors: ${RAW_MENTORS.length}</div>
      <div style="overflow:auto;max-height:380px;border:1px solid var(--border);border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Field</th>
              <th>Region</th>
              <th>Availability</th>
              <th>Timezone</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;

    box.querySelectorAll("button[data-action]").forEach(btn=>{
      const tr = btn.closest("tr");
      const id = tr?.dataset.id;
      if(!id) return;
      btn.onclick = ()=>{
        if(btn.dataset.action==="edit"){
          const row = RAW_MENTORS.find(x=>x.id===id);
          if(row) fillAdminFormForEdit(row);
        }else if(btn.dataset.action==="delete"){
          handleDeleteMentor(id);
        }
      };
    });
  }

  function fillAdminFormForEdit(row){
    document.getElementById("adminMentorId").value = row.id;
    document.getElementById("adminName").value = row.name || "";
    document.getElementById("adminEmail").value = row.email || "";
    document.getElementById("adminRegion").value = row.region || "";
    document.getElementById("adminCountry").value = row.country || "";
    document.getElementById("adminTimezone").value = row.timezone || "";
    document.getElementById("adminField").value = row.field || "";
    document.getElementById("adminRole").value = row.role || "";
    document.getElementById("adminYearExperience").value = row.year_experience || "";
    document.getElementById("adminBio").value = row.bio || "";
    document.getElementById("adminMainGoal").value = row.main_goal || "";
    document.getElementById("adminExpectedOutcomes").value = row.expected_outcomes || "";
    document.getElementById("adminLinkedin").value = row.linkedin || "";
    document.getElementById("adminMenteeCapacity").value = row.mentee_capacity || "";

    const firstArea = toArray(row.areas_mentor || "")[0] || "";
    document.getElementById("adminAreasMentor").value = firstArea;

    const firstLevel = toArray(row.experience_levels || "")[0] || "";
    document.getElementById("adminExperienceLevels").value = firstLevel;

    document.getElementById("adminAreasMentorOther").value = "";
    document.getElementById("adminExperienceLevelsOther").value = "";

    document.getElementById("adminAvailability").value = row.availability || "";
    document.getElementById("adminCommunication").value = row.communication || "";

    document.getElementById("adminFormStatus").textContent = "Editing existing mentor. Make changes and click Save.";
  }

  function clearAdminForm(){
    ["adminMentorId","adminName","adminEmail","adminRegion","adminCountry","adminTimezone",
     "adminField","adminRole","adminYearExperience","adminBio","adminMainGoal",
     "adminExpectedOutcomes","adminAvailability","adminCommunication",
     "adminLinkedin","adminMenteeCapacity",
     "adminAreasMentorOther","adminExperienceLevelsOther",
     "adminAreasMentor","adminExperienceLevels"
    ].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.value="";
    });

    document.getElementById("adminFormStatus").textContent = "";
  }

  async function handleSaveMentor(){
    const id = document.getElementById("adminMentorId").value || null;
    const name = document.getElementById("adminName").value.trim();
    const email = document.getElementById("adminEmail").value.trim();

    if(!name || !email){
      showToast("Name and email are required",{type:"error"});
      document.getElementById("adminFormStatus").textContent = "Name and email are required.";
      return;
    }

    const areasSelected = getSelectValue("adminAreasMentor");
    const areasOther = document.getElementById("adminAreasMentorOther").value.trim();
    const areasFinal = [areasSelected, areasOther].filter(Boolean).join(", ");

    const levelsSelected = getSelectValue("adminExperienceLevels");
    const levelsOther = document.getElementById("adminExperienceLevelsOther").value.trim();
    const levelsFinal = [levelsSelected, levelsOther].filter(Boolean).join(", ");

    const payload = {
      name,
      email,
      region: document.getElementById("adminRegion").value.trim() || null,
      country: document.getElementById("adminCountry").value.trim() || null,
      timezone: document.getElementById("adminTimezone").value.trim() || null,
      field: document.getElementById("adminField").value.trim() || null,
      role: document.getElementById("adminRole").value.trim() || null,
      year_experience: document.getElementById("adminYearExperience").value.trim() || null,
      bio: document.getElementById("adminBio").value.trim() || null,
      main_goal: document.getElementById("adminMainGoal").value.trim() || null,
      areas_mentor: areasFinal || null,
      experience_levels: levelsFinal || null,
      expected_outcomes: document.getElementById("adminExpectedOutcomes").value.trim() || null,
      availability: document.getElementById("adminAvailability").value.trim() || null,
      communication: document.getElementById("adminCommunication").value.trim() || null,
      linkedin: document.getElementById("adminLinkedin").value.trim() || null,
      mentee_capacity: document.getElementById("adminMenteeCapacity").value.trim() || null
    };

    try{
      document.getElementById("adminFormStatus").textContent = id ? "Updating mentor‚Ä¶" : "Adding mentor‚Ä¶";
      let error;
      if(id){
        ({ error } = await supabase
          .from("mentors")
          .update(payload)
          .eq("id", id));
      }else{
        ({ error } = await supabase
          .from("mentors")
          .insert([payload]));
      }
      if(error) throw error;
      showToast(id ? "Mentor updated ‚úÖ" : "Mentor added ‚úÖ");
      clearAdminForm();
      await loadMentors();
    }catch(e){
      console.error(e);
      document.getElementById("adminFormStatus").textContent = "Error: " + (e.message||e);
      showToast("Error saving mentor: "+(e.message||"Unknown error"),{type:"error"});
    }
  }

  async function handleDeleteMentor(id){
    if(!id) return;
    if(!confirm("Are you sure you want to delete this mentor? This cannot be undone.")) return;
    try{
      const { error } = await supabase
        .from("mentors")
        .delete()
        .eq("id", id);
      if(error) throw error;
      showToast("Mentor deleted");
      await loadMentors();
    }catch(e){
      console.error(e);
      showToast("Error deleting mentor: "+(e.message||"Unknown error"),{type:"error"});
    }
  }

  /* ------------ Requests + Inbox ------------ */
  async function sendRequest(email){
    if(!window.supabase){
      showToast("Database not ready yet.",{type:"error"});
      return;
    }
    if(!mentee.email){
      showToast("Please save your mentee profile (with email) first.",{type:"error"});
      return;
    }
    const payload={
      mentor_email:email,
      mentee_email:mentee.email,
      mentee_name:mentee.name,
      status:"pending",
      note:mentee.interests || mentee.goal || "",
      created_at:new Date().toISOString()
    };
    try{
      const { error } = await supabase.from("requests").insert([payload]);
      if(error) throw error;
      showToast("Request sent ‚úÖ");
      loadMyRequests();
    }catch(e){
      console.error(e);
      showToast("Error sending request: "+(e.message || "check Supabase 'requests' table & RLS"),{type:"error"});
    }
  }

  async function loadInbox(){
    const email=document.getElementById("inboxEmail").value.trim();
    const box=document.getElementById("inbox");
    box.innerHTML="";
    if(!email){
      box.innerHTML="<div class='muted'>Enter mentor email to load inbox.</div>";
      return;
    }
    try{
      const { data, error } = await supabase
        .from("requests")
        .select("*")
        .eq("mentor_email", email)
        .order("created_at",{ascending:false});
      if(error) throw error;
      if(!data.length){
        box.innerHTML="<div class='muted'>No requests yet.</div>";
        showToast("Inbox refreshed");
        return;
      }
      box.innerHTML="";
      data.forEach(r=>{
        const c=document.createElement("div");
        c.className="card";
        c.style.margin="8px 0";
        c.innerHTML=`
          <strong>${r.mentee_name||r.mentee_email}</strong> <span class="pill">${r.status}</span>
          <div class="muted">${r.mentee_email}</div>
          <div class="rowblock">${r.note||""}</div>
          <div class="rowblock">
            <button class="btn-small" data-id="${r.id}" data-s="accepted">Accept</button>
            <button class="btn-small btn-danger" data-id="${r.id}" data-s="declined">Decline</button>
            <a class="pill" href="mailto:${r.mentee_email}?subject=Re:%20Mentorship%20Request">Email</a>
          </div>`;
        box.appendChild(c);
      });
      box.querySelectorAll("button[data-id]").forEach(b=>b.onclick=async()=>{
        try{
          const { error } = await supabase
            .from("requests")
            .update({status:b.dataset.s})
            .eq("id", b.dataset.id);
          if(error) throw error;
          showToast(`Request ${b.dataset.s} ‚úÖ`);
          loadInbox();
        }catch(e){
          console.error(e);
          showToast("Update failed: "+(e.message||"Unknown error"),{type:"error"});
        }
      });
      showToast("Inbox refreshed");
    }catch(e){
      console.error(e);
      box.innerHTML="<div class='error'>Inbox error: "+(e.message||e)+"</div>";
      showToast("Inbox error: "+(e.message||"Unknown error"),{type:"error"});
    }
  }

  let myReqChannel=null;
  function renderMyRequests(rows){
    const box=document.getElementById("myRequests");
    if(!box) return;
    if(!rows || !rows.length){
      box.classList.add("muted");
      box.innerHTML="<div class='muted'>No requests yet.</div>";
      return;
    }
    box.classList.remove("muted");
    box.innerHTML=rows.map(r=>`
      <div class="card" style="margin:8px 0;">
        <strong>${r.mentor_email}</strong>
        <span class="pill">${r.status}</span>
        <div class="muted">${new Date(r.created_at).toLocaleString()}</div>
        ${r.note?`<div class="rowblock">${r.note}</div>`:""}
      </div>
    `).join("");
  }
  async function loadMyRequests(){
    if(!supabase || !mentee?.email){
      const box=document.getElementById("myRequests");
      if(box) box.innerHTML="<div class='muted'>Enter and save your email first.</div>";
      return;
    }
    try{
      const { data, error } = await supabase
        .from("requests")
        .select("*")
        .eq("mentee_email", mentee.email)
        .order("created_at",{ascending:false});
      if(error) throw error;
      renderMyRequests(data);
    }catch(e){
      console.error(e);
      document.getElementById("myRequests").innerHTML="<div class='error'>Failed to load: "+(e.message||e)+"</div>";
    }
  }
  function subscribeMyRequests(email){
    if(!supabase || !email) return;
    if(myReqChannel){
      try{ supabase.removeChannel(myReqChannel); }catch(_){}
      myReqChannel=null;
    }
    myReqChannel = supabase.channel("requests_for_"+email)
      .on("postgres_changes",{
        event:"*",
        schema:"public",
        table:"requests",
        filter:`mentee_email=eq.${email}`
      }, payload=>{
        if(payload.eventType==="UPDATE"){
          const newStatus=payload.new?.status;
          if(newStatus){
            showToast(`Your request was ${newStatus}`,{
              type:newStatus==="accepted"?"success":"error"
            });
          }
        }
        loadMyRequests();
      })
      .subscribe(status=>{
        if(status==="SUBSCRIBED"){
          console.log("‚úÖ Realtime subscribed for mentee:",email);
        }
      });
  }

  /* ------------ Mentee profile auto-apply ------------ */
  function attachOtherInput(selectId, otherInputId){
    const sel=document.getElementById(selectId);
    const other=document.getElementById(otherInputId);
    if(!sel || !other) return;
    sel.addEventListener("change", ()=>{
      const val=(sel.value||"").toLowerCase();
      if(val.includes("other")){
        other.style.display="";
      }else{
        other.style.display="none";
        other.value="";
      }
      autoApply();
    });
  }

  const autoApply = debounce(()=>{
    const regionSel = document.getElementById("menteeRegion")?.value || "";
    const regionOtherEl = document.getElementById("menteeRegionOther");
    let region = regionSel;
    if(regionSel.toLowerCase().includes("other") && regionOtherEl && regionOtherEl.value.trim()){
      region = regionOtherEl.value.trim();
    }

    const countrySel = document.getElementById("menteeCountry")?.value || "";
    const countryOtherEl = document.getElementById("menteeCountryOther");
    let country = countrySel;
    if(countrySel.toLowerCase().includes("other") && countryOtherEl && countryOtherEl.value.trim()){
      country = countryOtherEl.value.trim();
    }

    const tzSel = document.getElementById("menteeTimezone")?.value || "";
    const tzOtherEl = document.getElementById("menteeTimezoneOther");
    let timezone = tzSel;
    if(tzSel.toLowerCase().includes("other") && tzOtherEl && tzOtherEl.value.trim()){
      timezone = tzOtherEl.value.trim();
    }

    const fieldSel = document.getElementById("menteeField")?.value || "";
    const fieldOtherEl = document.getElementById("menteeFieldOther");
    let field = fieldSel;
    if(fieldSel.toLowerCase().includes("other") && fieldOtherEl && fieldOtherEl.value.trim()){
      field = fieldOtherEl.value.trim();
    }

    const areasSel = document.getElementById("menteeAreas")?.value || "";
    const areasOtherEl = document.getElementById("menteeAreasOther");
    let areas = areasSel;
    if(areasSel.toLowerCase().includes("other") && areasOtherEl && areasOtherEl.value.trim()){
      areas = areasOtherEl.value.trim();
    }

    const availSel = document.getElementById("menteeAvailability")?.value || "";
    const availOtherEl = document.getElementById("menteeAvailabilityOther");
    let availability = availSel;
    if(availSel.toLowerCase().includes("other") && availOtherEl && availOtherEl.value.trim()){
      availability = availOtherEl.value.trim();
    }

    const commSel = document.getElementById("menteeCommunication")?.value || "";
    const commOtherEl = document.getElementById("menteeCommunicationOther");
    let communication = commSel;
    if(commSel.toLowerCase().includes("other") && commOtherEl && commOtherEl.value.trim()){
      communication = commOtherEl.value.trim();
    }

    mentee = {
      name:   document.getElementById("menteeName").value.trim(),
      email:  document.getElementById("menteeEmail").value.trim(),
      region,
      country,
      timezone,
      field,
      interests: document.getElementById("menteeInterests").value.trim(),
      goal:         document.getElementById("menteeGoal")?.value.trim() || "",
      outcome:      document.getElementById("menteeOutcome")?.value.trim() || "",
      areas,
      level:        document.getElementById("menteeLevel")?.value || "",
      availability,
      communication
    };

    localStorage.setItem("mentee", JSON.stringify(mentee));
    apply();
    if(window._sbReady && mentee.email){
      subscribeMyRequests(mentee.email);
      loadMyRequests();
    }
  }, 350);

  /* ------------ Event wiring ------------ */
  function initEvents(){
    attachOtherInput("menteeRegion","menteeRegionOther");
    attachOtherInput("menteeCountry","menteeCountryOther");
    attachOtherInput("menteeTimezone","menteeTimezoneOther");
    attachOtherInput("menteeField","menteeFieldOther");
    attachOtherInput("menteeAreas","menteeAreasOther");
    attachOtherInput("menteeAvailability","menteeAvailabilityOther");
    attachOtherInput("menteeCommunication","menteeCommunicationOther");

    ["menteeRegionOther","menteeCountryOther","menteeTimezoneOther",
     "menteeFieldOther","menteeAreasOther","menteeAvailabilityOther","menteeCommunicationOther"
    ].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.addEventListener("input", autoApply);
    });

    ["menteeInterests","menteeGoal","menteeOutcome","menteeName","menteeEmail"].forEach(id=>{
      const el=document.getElementById(id);
      if(el){
        const ev = (id==="menteeName"||id==="menteeEmail") ? "blur" : "input";
        el.addEventListener(ev, autoApply);
      }
    });
    ["menteeRegion","menteeCountry","menteeTimezone","menteeField","menteeAreas","menteeLevel","menteeAvailability","menteeCommunication"]
      .forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.addEventListener("change", autoApply);
      });

    document.getElementById("search").oninput = e => {
      F.q = e.target.value;
      apply();
    };

    document.getElementById("btnSaveMentee").onclick = ()=>{
      autoApply();
      showToast("Matches updated ‚Äî scroll to see your recommendations. Your best matches are shown under 'Recommended for you' below.");
      const rec = document.getElementById("mentors");
      if(rec){
        rec.scrollIntoView({behavior:"smooth", block:"start"});
      }
    };

    document.getElementById("btnClearMentee").onclick = ()=>{
      [
        "menteeName","menteeEmail",
        "menteeRegion","menteeRegionOther",
        "menteeCountry","menteeCountryOther",
        "menteeTimezone","menteeTimezoneOther",
        "menteeField","menteeFieldOther",
        "menteeInterests",
        "menteeGoal","menteeOutcome",
        "menteeAreas","menteeAreasOther",
        "menteeLevel",
        "menteeAvailability","menteeAvailabilityOther",
        "menteeCommunication","menteeCommunicationOther"
      ].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.value="";
      });

      [
        "menteeRegionOther","menteeCountryOther","menteeTimezoneOther",
        "menteeFieldOther","menteeAreasOther","menteeAvailabilityOther",
        "menteeCommunicationOther"
      ].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.style.display="none";
      });

      mentee = {};
      F.q = "";
      const s=document.getElementById("search");
      if(s) s.value="";

      VIEW = [];
      const host=document.getElementById("mentors");
      if(host){
        host.innerHTML="<div class='muted'>Add your details to see recommendations.</div>";
      }
      const hint=document.getElementById("suggestionHint");
      if(hint){
        hint.textContent="Add your interests, region and field ‚Äî we‚Äôll tailor your matches here.";
      }

      const myBox=document.getElementById("myRequests");
      if(myBox){
        myBox.classList.add("muted");
        myBox.innerHTML="<div class='muted'>No requests yet.</div>";
      }

      if(myReqChannel){
        try{ supabase.removeChannel(myReqChannel); }catch(_){}
        myReqChannel=null;
      }

      localStorage.removeItem("mentee");

      showToast("Profile cleared");
    };

    document.getElementById("btnRefreshMyRequests").onclick = ()=>{ loadMyRequests(); showToast("My Requests refreshed"); };

    document.getElementById("btnLoadInbox").onclick = ()=>{ loadInbox(); };
    document.getElementById("btnRefreshInbox").onclick = ()=>{ loadInbox(); showToast("Inbox refreshed"); };

    document.getElementById("btnSaveMentor").onclick = handleSaveMentor;
    document.getElementById("btnResetMentor").onclick = clearAdminForm;

    // üîê Tab switching between views
    document.querySelectorAll(".tab").forEach(t=>{
      t.onclick=()=>{
        const target = t.dataset.view;
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        ["mentee","mentor","admin"].forEach(v=>{
          const section = document.getElementById("view-"+v);
          if(section) section.style.display = (v===target) ? "" : "none";
        });
      };
    });

    // üîê Admin login / logout wiring
    const loginBtn = document.getElementById("btnAdminLogin");
    if(loginBtn){
      loginBtn.onclick = async ()=>{
        const email = (document.getElementById("adminLoginEmail").value || "").trim();
        const password = document.getElementById("adminLoginPassword").value;
        const statusEl = document.getElementById("adminLoginStatus");
        if(statusEl) statusEl.textContent = "Signing in‚Ä¶";
        try{
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if(error){
            if(statusEl) statusEl.textContent = "Login failed: " + (error.message || "");
            showToast("Admin login failed",{type:"error"});
            return;
          }
          if(statusEl) statusEl.textContent = "";
          showToast("Admin logged in ‚úÖ");
          checkAdminSession();
        }catch(e){
          console.error(e);
          if(statusEl) statusEl.textContent = "Login error.";
          showToast("Admin login error",{type:"error"});
        }
      };
    }

    const logoutBtn = document.getElementById("btnAdminLogout");
    if(logoutBtn){
      logoutBtn.onclick = async ()=>{
        try{
          await supabase.auth.signOut();
        }catch(e){
          console.error(e);
        }
        showToast("Logged out");
        checkAdminSession();
      };
    }
  }

  /* ------------ Init ------------ */
  (async ()=>{
    initEvents();
    checkAdminSession();
    if(window.supabase && supabase.auth && supabase.auth.onAuthStateChange){
      supabase.auth.onAuthStateChange((_event,_session)=>{ checkAdminSession(); });
    }
    try{
      mentee = JSON.parse(localStorage.getItem("mentee")||"{}");
    }catch{ mentee={}; }
    if(mentee){
      if(mentee.name) document.getElementById("menteeName").value = mentee.name;
      if(mentee.email) document.getElementById("menteeEmail").value = mentee.email;
      if(mentee.region) document.getElementById("menteeRegion").value = mentee.region;
      if(mentee.country) document.getElementById("menteeCountry").value = mentee.country;
      if(mentee.timezone) document.getElementById("menteeTimezone").value = mentee.timezone;
      if(mentee.field) document.getElementById("menteeField").value = mentee.field;
      if(mentee.interests) document.getElementById("menteeInterests").value = mentee.interests;
      if(mentee.goal) document.getElementById("menteeGoal").value = mentee.goal;
      if(mentee.outcome) document.getElementById("menteeOutcome").value = mentee.outcome;
      if(mentee.areas) document.getElementById("menteeAreas").value = mentee.areas;
      if(mentee.level) document.getElementById("menteeLevel").value = mentee.level;
      if(mentee.availability) document.getElementById("menteeAvailability").value = mentee.availability;
      if(mentee.communication) document.getElementById("menteeCommunication").value = mentee.communication;
    }
    if(window._sbReady && mentee?.email){
      subscribeMyRequests(mentee.email);
      loadMyRequests();
    }
    await loadMentors();
  })();
</script>
</body>
</html>
